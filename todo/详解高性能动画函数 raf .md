# 详解前端高性能动画利器 raf

今年下半年打算正式撸一撸游戏，正好这些天再整理图形渲染方面的知识点，当然了，目前还是打算使用浏览器进行游戏开发。 

## 网页游戏开发的优势与未来

对于游戏开发来说，大部分开发都是动画，而动画本质上就是不断地基于时间更新状态以及重新绘制界面。

对于其他语言来说，在开发中都需要先构建界面，然后基于时间不断重新绘制。本身来说浏览器直接提供了这两个关键点，我们可以在浏览器中直接进行业务处理。对于我这种玩票性质的开发者来说，网页端开发更加合适，我可以更快的学习游戏本身的逻辑。

随着时间的发展，浏览器的功能，性能。WebGL, WebAssembly 各种层出不穷的技术。让很多之前想都不敢想的功能在浏览器上实现。同时,伴随着 5G 的到来，网速的提升，想必网页游戏可以到达更高的层次。

## 屏幕刷新率与 FPS

不知道大家在小学的时候有没有买果或者玩过翻纸动画？如果你没有了解过，也可以看一看bilibili 中的视频 [高中生自制的翻纸动画短片]( https://www.bilibili.com/video/av24463374/?p=2)。视频中通过快速翻动纸张来实现两个火彩人打架的精彩动画。事实上，我们的电脑，手机设备能够展示都是基于此原理。

当物体在快速运动时, 人眼所看到的影像消失后，人眼仍能继续保留其影像1/24秒左右的图像，这种现象被称为视觉暂留现象。是人眼具有的一种性质。人眼观看物体时，成像于视网膜上，并由视神经输入人脑，感觉到物体的像。但当物体移去时，视神经对物体的印象不会立即消失，而要延续1/24秒左右的时间，人眼的这种性质被称为“眼睛的视觉暂留”。

该特性也就是我们所说的 FPS 每秒传输帧数(Frames Per Second).

**网页动画的每一帧（frame）都是一次重新渲染。**每秒低于24帧的动画，人眼就能感受到停顿。**一般的网页动画，需要达到每秒30帧到60帧的频率，才能比较流畅。**如果能达到每秒70帧甚至80帧，就会极其流畅。

屏幕刷新率即图像在屏幕上更新的速度，也即屏幕上的图像每秒钟出现的次数，它的单位是赫兹(Hz)。 对于一般笔记本电脑，这个频率大概是 60Hz，在  Window 10 上 可以通过桌面上**右键->显示设置->高级显示设置** 中查看和设置。屏幕刷新率表示显示器的物理刷新速度。

![image-20200512223617840](C:\Users\wsafight\AppData\Roaming\Typora\typora-user-images\image-20200512223617840.png)

对于我的电脑来说，无论我在浏览网页或者什么也不做，当前显示器也以 1 秒刷新 165 次当前的界面，该数值取决于显示器。

我们也可以通过修改**适配器属性->监视器**来调整屏幕刷新率,一般来说，我们只要调整到眼睛舒服即可。

如果我们需要购买一台

不知道大家在小学的时候有没有买果或者玩过翻纸动画？如果你没有了解过，也可以看一看bilibili 中的视频 [高中生自制的翻纸动画短片]( https://www.bilibili.com/video/av24463374/?p=2)。视频中通过快速翻动纸张来实现两个火彩人打架的精彩动画。事实上，我们的电脑，手机设备能够展示都是基于此原理。

当物体在快速运动时, 人眼所看到的影像消失后，人眼仍能继续保留其影像1/24秒左右的图像，这种现象被称为视觉暂留现象。是人眼具有的一种性质。人眼观看物体时，成像于视网膜上，并由视神经输入人脑，感觉到物体的像。但当物体移去时，视神经对物体的印象不会立即消失，而要延续1/24秒左右的时间，人眼的这种性质被称为“眼睛的视觉暂留”。

该特性也就是我们所说的 FPS 每秒传输帧数(Frames Per Second).

**网页动画的每一帧（frame）都是一次重新渲染。**每秒低于24帧的动画，人眼就能感受到停顿。**一般的网页动画，需要达到每秒30帧到60帧的频率，才能比较流畅。**如果能达到每秒70帧甚至80帧，就会极其流畅。



## requestAnimationFrame (Raf) 作用与目的

针对于浏览器来说，我们无法介入的循环机制，所以我们都是通过定时器回调函数来实现。而回调函数本身也就是在浏览器的主循环中不断调用查询延时消息队列中的事件是否到达触发时机，如果到达了触发时机，则直接在主循环中执行事件。以伪代码的形式可以这样表示:

```js

```

重点在于，浏览器本身是单线程的，如果其他事件执行的时间过久的话，定时器任务也是不准确的。当然了 requestAnimationFrame 也是回调，那么它必然也有过人之处让

##  

设置这个API的目的是为了让各种网页动画效果（DOM动画、Canvas动画、SVG动画、WebGL动画）能够有一个统一的刷新机制，从而节省系统资源，提高系统性能，改善视觉效果。代码中使用这个API，就是告诉浏览器希望执行一个动画，让浏览器在下一个动画帧安排一次网页重绘。

我们知道 CSS 动画是由渲染进程自动处理的，所以渲染进程会让 CSS 渲染每帧动画的过程与 VSync 的时钟保持一致, 这样就能保证 CSS 动画的高效率执行。

但是 JavaScript 是由用户控制的，如果采用 setTimeout 来触发动画每帧的绘制，那么其绘制时机是很难和 VSync 时钟保持一致的，所以 JavaScript 中又引入了 window.requestAnimationFrame，用来和 VSync 的时钟周期同步，那么我留给你的问题是：你知道 requestAnimationFrame 回调函数的执行时机吗？



但是 JavaScript 是由用户控制的，如果采用 setTimeout 来触发动画每帧的绘制，那么其绘制时机是很难和 VSync 时钟保持一致的





如果你打大型单机游戏或者你的电脑有些



## requestAnimationFrame 特性

一旦页面不处于浏览器的当前标签，就会自动停止刷新。这就节省了CPU、GPU和电力，requestAnimationFrame  会不断下降，同理 requestIdea 也是如此。

对于





所以如果需要 js 动画，我们需要定时器回调来实现动画效果。

定时器





requestAnimationFrame的优势，在于充分利用显示器的刷新机制，比较节省系统资源。显示器有固定的刷新频率（60Hz或75Hz），也就是说，每秒最多只能重绘60次或75次，requestAnimationFrame的基本思想就是与这个刷新频率保持同步，利用这个刷新频率进行页面重绘。此外，使用这个API，一旦页面不处于浏览器的当前标签，就会自动停止刷新。这就节省了CPU、GPU和电力。

不过有一点需要注意，requestAnimationFrame是在主线程上完成。这意味着，如果主线程非常繁忙，requestAnimationFrame的动画效果会大打折扣。

requestAnimationFrame使用一个回调函数作为参数。这个回调函数会在浏览器重绘之前调用。

requestAnimationFrame 是为了更好的渲染动画而提出的，他的调度完全取决于浏览器的渲染等因素，如果你需要做其它功能性操作，定时器仍旧是更好的选择。

## 其他

同样的函数也有





https://blog.csdn.net/vhwfr2u02q/article/details/79492303

https://www.sohu.com/a/325643652_120099902



https://docs.google.com/document/d/16822du6DLKDZ1vQVNWI3gDVYoSqCSezgEmWZ0arvkP8/edit